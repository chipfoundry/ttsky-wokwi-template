name: fpga

on:
  push:
    # Comment out (or remove) the following line to run the FPGA workflow on every push:
    branches: none
  workflow_dispatch:

jobs:
  fpga:
    runs-on: ubuntu-24.04
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: FPGA bitstream for TT ASIC Sim (ICE40UP5K)
        uses: TinyTapeout/tt-gds-action/fpga/ice40up5k@ttsky25b

      - name: Checkout tt-support-tools repo
        uses: actions/checkout@v4
        with:
          repository: chipfoundry/tt-support-tools
          path: tt
          ref: efabless

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install tt-support-tools dependencies
        shell: bash
        run: |
          pip install -r tt/requirements.txt
          pip install pyyaml

      - name: Create the UF2
        shell: bash
        run: |
          CLOCKRATE=$(python -c "import yaml; data = yaml.safe_load(open('info.yaml')); print(data['project']['clock_hz'])")
          if [ -z "$CLOCKRATE" ] || [ "$CLOCKRATE" = "0" ]; then
            echo "Warning: Clock rate is 0 or not set, using default"
            CLOCKRATE=1000000
          fi
          TITLE=$(python -c "import yaml; data = yaml.safe_load(open('info.yaml')); print(data['project'].get('title', 'TinyTapeout'))")
          if [ -z "$TITLE" ]; then
            TITLE="TinyTapeout"
          fi
          if [ ! -f build/tt_fpga.bin ]; then
            echo "Error: Bitstream file not found at build/tt_fpga.bin"
            exit 1
          fi
          python tt/fpga/bitstream_to_uf2.py --target efabless --slot 1 --name "$TITLE" --autoclock $CLOCKRATE build/tt_fpga.bin build/tt_fpga.uf2

      - name: Verify UF2 created
        run: |
          if [ ! -f build/tt_fpga.uf2 ]; then
            echo "Error: UF2 file not created"
            exit 1
          fi
          echo "UF2 file created successfully: build/tt_fpga.uf2"

      - name: Upload UF2 and additional files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fpga_uf2_files
          path: |
            build/tt_fpga.uf2
            build/tt_fpga.bin
            docs/*
            src/*
            info.yaml
            LICENSE
          if-no-files-found: warn
